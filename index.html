<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>é…ä»¶æ‰«ç å½•å…¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link crossorigin="anonymous" href="https://lib.baomitu.com/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link crossorigin="anonymous" href="https://lib.baomitu.com/highlight.js/11.10.0/styles/github-dark.css" rel="stylesheet" />
  <script crossorigin="anonymous" src="https://lib.baomitu.com/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script crossorigin="anonymous" src="https://lib.baomitu.com/highlight.js/11.10.0/highlight.min.js"></script>
</head>

<body class="container mb-5">
  <h5 class="text-center pt-2"><i class="bi bi-qr-code-scan px-2"></i>é…ä»¶æ‰«ç å½•å…¥</h5>
  <div id="toastContainer" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 9999;"></div>

  <div class="row my-3">
    <div class="col">
      <label class="form-label fw-bold" for="orderNo">å•å·ï¼š</label>
      <input id="orderNo" type="text" class="form-control" placeholder="è¯·è¾“å…¥å•å·">
      <div id="orderNoDisplay" class="text-muted mt-1"></div>
    </div>
    <div class="col text-end">
      <label class="form-label fw-bold" for="type">é…ä»¶ç±»å‹ï¼š</label>
      <select id="type" class="form-select">
        <option value="CPU">CPU</option>
        <option value="å†…å­˜">å†…å­˜</option>
        <option value="ç¡¬ç›˜">ç¡¬ç›˜</option>
        <option value="å…‰æ¨¡å—">å…‰æ¨¡å—</option>
        <option value="AOCçº¿ç¼†">AOCçº¿ç¼†</option>
        <option value="ä¸»æ¿">ä¸»æ¿</option>
        <option value="ç”µæº">ç”µæº</option>
        <option value="ç½‘å¡">ç½‘å¡</option>
        <option value="äº¤æ¢æœº">äº¤æ¢æœº</option>
      </select>
    </div>
  </div>

  <div id="switchInfoRow" class="row my-3 d-none">
    <div class="col-8 pe-1">
      <label class="form-label" for="switchLocation">äº¤æ¢æœºä½ç½®ï¼š</label>
      <input id="switchLocation" type="text" class="form-control" placeholder="">
    </div>
    <div class="col-4 ps-1 text-end">
      <label class="form-label" for="portNo">ç«¯å£ï¼š</label>
      <input id="portNo" type="text" class="form-control" placeholder="">
    </div>
  </div>

  <div id="serverSNRow" class="my-3">
    <label class="form-label font-monospace" for="serverSN"><i class="bi bi-server px-1"></i>æœåŠ¡å™¨SNï¼š</label>
    <input id="serverSN" type="text" class="form-control" placeholder="è¯·æ‰«ç ">
  </div>

  <div id="brandSection" class="row my-3 d-none">
    <div class="col">
      <label class="form-label text-danger fw-bold" for="newBrand">æ–°ä»¶å“ç‰Œï¼š</label>
      <select id="newBrand" class="form-select"></select>
    </div>
    <div class="col text-end">
      <label class="form-label text-secondary fw-bold" for="oldBrand">æ—§ä»¶å“ç‰Œï¼š</label>
      <select id="oldBrand" class="form-select"></select>
    </div>
  </div>

  <div class="form-group my-3">
    <label class="form-label d-flex justify-content-between" for="newSN">
      <span class="text-danger fw-bold">æ–°ä»¶SNï¼š</span><small id="countNewSN" class="text-muted">å­—ç¬¦æ•°ï¼š0</small>
    </label>
    <input id="newSN" type="text" class="form-control" placeholder="">
  </div>

<div class="form-group my-3">
  <label class="form-label d-flex justify-content-between" for="newPN">
    <span class="text-danger fw-bold">æ–°ä»¶PNï¼š</span><span id="checkNewPN" class="text-success"></span><small id="countNewPN" class="text-muted">å­—ç¬¦æ•°ï¼š0</small>
  </label>
  <input id="newPN" list="newPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
  <datalist id="newPnOptions"></datalist>
</div>



  <div class="form-group my-3">
    <label class="form-label d-flex justify-content-between" for="oldSN">
      <span class="text-secondary fw-bold">æ—§ä»¶SNï¼š</span><small id="countOldSN" class="text-muted">å­—ç¬¦æ•°ï¼š0</small>
    </label>
    <input id="oldSN" type="text" class="form-control" placeholder="">
  </div>

<div class="form-group my-3">
  <label class="form-label d-flex justify-content-between" for="oldPN">
    <span class="text-secondary fw-bold">æ—§ä»¶PNï¼š</span><span id="checkOldPN" class="text-success"></span><small id="countOldPN" class="text-muted">å­—ç¬¦æ•°ï¼š0</small>
  </label>
  <input id="oldPN" list="oldPnOptions" type="text" class="form-control" placeholder="" autocorrect="off">
  <datalist id="oldPnOptions"></datalist>
</div>
  <div class="d-flex justify-content-between align-items-center mb-1">
    <small class="form-label mb-0">é¢„è§ˆå†…å®¹ï¼š</small>
    <button id="copyBtn" class="btn btn-light"><i class="bi bi-copy pe-1"></i>ä¸€é”®å¤åˆ¶</button>
    <button class="btn btn-light" onclick="sendApplyNotify()"><i class="bi bi-megaphone-fill pe-1"></i>ç”³é¢†é€šçŸ¥</button>
    <button class="btn btn-light" onclick="sendToFeishu()"><i class="bi bi-send pe-1"></i>æ›¿æ¢é€šçŸ¥</button>
  </div>
  <pre class="rounded"><code id="preview" class="language-plaintext"></code></pre>

<script>
const brandMap = {
  'AOCçº¿ç¼†': ['HG GENUINE', 'INNOLIGHT', 'Hisense', 'WTD'],
  'å…‰æ¨¡å—': ['HG GENUINE', 'INNOLIGHT', 'Hisense', 'Huawei', 'Finisar', 'WTD'],
  'å†…å­˜': ['Samsung', 'Hynix', 'Micron'],
  'ç¡¬ç›˜': ['Seagate', 'Western Digital', 'Intel', 'Samsung', 'Micron', 'KIOXIA', 'Solidigm'],
  'CPU': ['Intel']
};

const pnDataMap = {
  'å…‰æ¨¡å—': {
    'HG GENUINE': ['MTRS-01X11-G', 'MQD-12F1C', 'MQD-56F2C', 'MTRQ-4S101'],
    'INNOLIGHT': ['T-OL8CNT-N00', 'T-DQ8FNS-N01', 'T-DQ8FNS-N00', 'TR-FC13T-N00', 'TR-ZC13T-N00', 'T-DQ4CNT-N00', 'TR-FC13R-N00'],
    'WTD': ['RTXM500-410', 'RTXM420-431', 'RTXM500-560', 'RTXM600-230', 'OEO-M100-73-13-Q28', 'OEO-M100-62-13-Q28', 'RTXM228-551', 'RTXM228-401', 'RTXM290-806', 'RTXM420-550'],
    'Finisar': ['FTCD8613E1PCM', 'FTLX8574D3BCL', 'FTCD8613E2PCM-BY', 'FTCE4717E1PCB-BY', 'FTLX1475D3BCL'],
    'Huawei': ['OM3680SX200', 'OM3660FX102'],
    'Hisense': ['LMQ8811-PC+', 'LMS3821L-PCS', 'LTF8502-BC+', 'LMS3826-PC+', 'LTA1328-PC+'],
    'Crealights': ['B5CLOS800SR8'],
    'H3C': ['SFP-XG-LX-SM1310']
  },
  'AOCçº¿ç¼†': {
    'HG GENUINE': ['ATRP-B005', 'ATRP-B007', 'ATRP-B010', 'ATRP-B020'],
    'INNOLIGHT': ['C-PD2FNM005-N00', 'C-PD2FNM007-N00', 'C-PD2FNM010-N00'],
    'Hisense': ['DMM8211-DC05', 'DMM8211-DC07', 'DMM8211-DC10', 'DMM8211-DC20'],
    'WTD': ['RTXM520-105', 'RTXM520-107', 'RTXM520-110', 'RTXM520-120', 'RTXM500-905', 'RTXM500-910']
  }
};

const orderNo = document.getElementById('orderNo');
const typeSelect = document.getElementById('type');
const switchLocation = document.getElementById('switchLocation');
const portNo = document.getElementById('portNo');
const serverSN = document.getElementById('serverSN');
const serverSNRow = document.getElementById('serverSNRow');
const switchInfoRow = document.getElementById('switchInfoRow');

const newBrand = document.getElementById('newBrand');
const oldBrand = document.getElementById('oldBrand');
const newPN = document.getElementById('newPN');
const oldPN = document.getElementById('oldPN');
const newSN = document.getElementById('newSN');
const oldSN = document.getElementById('oldSN');

const newPnOptions = document.getElementById('newPnOptions');
const oldPnOptions = document.getElementById('oldPnOptions');

const countNewPN = document.getElementById('countNewPN');
const countNewSN = document.getElementById('countNewSN');
const countOldPN = document.getElementById('countOldPN');
const countOldSN = document.getElementById('countOldSN');
const checkNewPN = document.getElementById('checkNewPN');
const checkOldPN = document.getElementById('checkOldPN');
const preview = document.getElementById('preview');
const copyBtn = document.getElementById('copyBtn');

const orderNoDisplay = document.getElementById('orderNoDisplay');

orderNo.addEventListener('input', function() {
  const val = orderNo.value.trim();
  const num = val.match(/(\d+)(?!.*\d)/)?.[0] || '';
  orderNoDisplay.textContent = num ? `å•å·è¯†åˆ«ï¼š${num}` : '';
});

function showToast(msg, type = 'primary') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 show my-2`;
  toast.role = 'alert';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 1200);
}

function updateBrandOptions(type) {
  const brands = brandMap[type];
  const section = document.getElementById('brandSection');
  if (brands) {
    newBrand.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join('');
    oldBrand.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join('');
    section.classList.remove('d-none');
  } else {
    newBrand.innerHTML = '';
    oldBrand.innerHTML = '';
    section.classList.add('d-none');
  }
  updatePnOptions(type, newBrand.value, newPnOptions);
  updatePnOptions(type, oldBrand.value, oldPnOptions);
}

function updatePnOptions(type, brand, datalist) {
  const list = (pnDataMap[type] && pnDataMap[type][brand]) || [];
  datalist.innerHTML = list.map(pn => `<option value="${pn}">`).join('');
}

function formatSamsungMemoryPn(pn) {
  const index = pn.indexOf('M');
  return index !== -1 ? pn.slice(index) : pn;
}



function update() {
  const type = typeSelect.value;
  const order = orderNo.value.trim().match(/\d+/)?.[0] || '';
  const isOptical = type === 'å…‰æ¨¡å—';
  const switchLoc = switchLocation.value.trim();
  const port = portNo.value.trim();
  const server = serverSN.value.trim();
  const brand1 = newBrand.value || '';
  const brand2 = oldBrand.value || '';

  // ğŸ”§ å…³é”®ï¼šç”¨ let å£°æ˜å¯ä¿®æ”¹çš„å˜é‡
  let pn1 = newPN.value.trim();
  let sn1 = newSN.value.trim();
  let pn2 = oldPN.value.trim();
  let sn2 = oldSN.value.trim();

  // æ¸…é™¤æç¤º
  checkNewPN.textContent = '';
  checkOldPN.textContent = '';
  checkNewPN.className = '';
  checkOldPN.className = '';

  // Samsung å†…å­˜æ ¼å¼åŒ–é€»è¾‘
  if (type === 'å†…å­˜') {
    if (brand1 === 'Samsung' && pn1.length > 0) {
      const formatted = formatSamsungMemoryPn(pn1);
      pn1 = formatted;
      newPN.value = formatted;
    }

    if (brand2 === 'Samsung' && pn2.length > 0) {
      const formatted = formatSamsungMemoryPn(pn2);
      pn2 = formatted;
      oldPN.value = formatted;
    }
  }

  // âœ… å­—ç¬¦æ•°ç»Ÿè®¡ï¼ˆå¿…é¡»åœ¨æ ¼å¼åŒ–ä¹‹åï¼‰
  countNewPN.textContent = `å­—ç¬¦æ•°ï¼š${pn1.length}`;
  countNewSN.textContent = `å­—ç¬¦æ•°ï¼š${sn1.length}`;
  countOldPN.textContent = `å­—ç¬¦æ•°ï¼š${pn2.length}`;
  countOldSN.textContent = `å­—ç¬¦æ•°ï¼š${sn2.length}`;

  // Samsung æ ¼å¼æ ¡éªŒæç¤º
  if (type === 'å†…å­˜') {
    if (brand1 === 'Samsung' && pn1 && !pn1.startsWith('M')) {
      checkNewPN.textContent = 'è¯·æ£€æŸ¥å†…å­˜PN';
      checkNewPN.className = 'text-danger me-2';
    }

    if (brand2 === 'Samsung' && pn2 && !pn2.startsWith('M')) {
      checkOldPN.textContent = 'è¯·æ£€æŸ¥å†…å­˜PN';
      checkOldPN.className = 'text-danger me-2';
    }
  }

  // PN ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆå†…å­˜æˆ–ç¡¬ç›˜ï¼‰
  if ((type === 'å†…å­˜' || type === 'ç¡¬ç›˜') && brand1 && brand2 && brand1 === brand2) {
    if (pn1 && pn2) {
      if (pn1 === pn2) {
        checkNewPN.textContent = 'PNä¸€è‡´';
        checkOldPN.textContent = 'PNä¸€è‡´';
        checkNewPN.className = 'text-success me-2';
        checkOldPN.className = 'text-success me-2';
      } else {
        checkNewPN.textContent = 'PNä¸ä¸€è‡´';
        checkOldPN.textContent = 'PNä¸ä¸€è‡´';
        checkNewPN.className = 'text-danger me-2';
        checkOldPN.className = 'text-danger me-2';
      }
    }
  }

  // æ–‡æœ¬é¢„è§ˆç”Ÿæˆ
  const positionText = isOptical ? `${switchLoc} ${port}` : `æœåŠ¡å™¨SNï¼š${server}`;

  const text = `ä¸Šæ–°ä¸‹æ—§ï¼šæ›´æ¢ã€Œ${type}ã€
å•å·ï¼š${order}
${isOptical ? 'ä½ç½®ï¼š' + positionText : positionText}
æ–°ä»¶å“ç‰Œï¼š${brand1}
æ–°ä»¶SNï¼š${sn1}
æ–°ä»¶PNï¼š${pn1}
æ—§ä»¶å“ç‰Œï¼š${brand2}
æ—§ä»¶SNï¼š${sn2}
æ—§ä»¶PNï¼š${pn2}`;

  preview.textContent = text;
  hljs.highlightElement(preview);
}


// æ³¨å†Œäº‹ä»¶
typeSelect.addEventListener('change', () => {
  const type = typeSelect.value;
  const isOptical = type === 'å…‰æ¨¡å—';
  serverSNRow.classList.toggle('d-none', isOptical);
  switchInfoRow.classList.toggle('d-none', !isOptical);
  updateBrandOptions(type);
  update();
});

[newBrand, oldBrand].forEach((select, index) => {
  select.addEventListener('change', () => {
    const type = typeSelect.value;
    const datalist = index === 0 ? newPnOptions : oldPnOptions;
    updatePnOptions(type, select.value, datalist);
    update();
  });
});

[
  orderNo, serverSN, switchLocation, portNo,
  newPN, newSN, oldPN, oldSN
].forEach(el => el.addEventListener('input', update));

copyBtn.addEventListener('click', () => {
  const text = preview.innerText.trim();
  navigator.clipboard.writeText(text).then(() => {
    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }).catch(() => {
    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'danger');
  });
});

function sendToFeishu() {
  const type = typeSelect.value;
  const orderInput = orderNo.value.trim();

  // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´url
  const urlMatch = orderInput.match(/https?:\/\/[\S]+/);
  if (!urlMatch) {
    showToast('è¯·ç²˜è´´å®Œæ•´çš„å•å·é“¾æ¥', 'warning');
    return;
  }
  const orderUrl = urlMatch[0];
  const orderNum = orderUrl.match(/(\d+)(?!.*\d)/)?.[0] || '';
  if (!orderNum) {
    showToast('é“¾æ¥ä¸­æœªæ‰¾åˆ°å•å·æ•°å­—', 'warning');
    return;
  }

  const isOptical = type === 'å…‰æ¨¡å—';
  const switchLoc = switchLocation.value.trim();
  const port = portNo.value.trim();
  const server = serverSN.value.trim();
  const brand1 = newBrand.value || '';
  const brand2 = oldBrand.value || '';
  let pn1 = newPN.value.trim();
  let sn1 = newSN.value.trim();
  let pn2 = oldPN.value.trim();
  let sn2 = oldSN.value.trim();

  const contentArr = [
    [ { tag: 'text', text: `ä¸Šæ–°ä¸‹æ—§ï¼šæ›´æ¢ã€Œ${type}ã€` } ],
    [ { tag: 'text', text: 'å•å·ï¼š' }, { tag: 'a', text: orderNum, href: orderUrl } ],
    [ { tag: 'text', text: isOptical ? `ä½ç½®ï¼š${switchLoc} ${port}` : `æœåŠ¡å™¨SNï¼š${server}` } ],
    [ { tag: 'text', text: `æ–°ä»¶å“ç‰Œï¼š${brand1}` } ],
    [ { tag: 'text', text: `æ–°ä»¶SNï¼š${sn1}` } ],
    [ { tag: 'text', text: `æ–°ä»¶PNï¼š${pn1}` } ],
    [ { tag: 'text', text: `æ—§ä»¶å“ç‰Œï¼š${brand2}` } ],
    [ { tag: 'text', text: `æ—§ä»¶SNï¼š${sn2}` } ],
    [ { tag: 'text', text: `æ—§ä»¶PNï¼š${pn2}` } ]
  ];

  // ä¿®æ­£ç»“æ„ï¼Œå¤–å±‚åŠ post
  const feishuPost = {
    post: {
      zh_cn: {
        title: 'é…ä»¶æ›´æ¢é€šçŸ¥',
        content: contentArr
      }
    }
  };

  fetch('https://test.jsjs.net', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ feishuPost }),
  })
  .then(async res => {
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(errText || 'ç½‘ç»œé”™è¯¯');
    }
    return res.json();
  })
  .then(data => {
    showToast('å·²å‘é€åˆ°é£ä¹¦ âœ…', 'success');
    console.log(data);
  })
  .catch(err => {
    showToast('å‘é€å¤±è´¥ âŒ', 'danger');
    console.error(err);
  });
}

// æ–°å¢ç”³é¢†é€šçŸ¥å‡½æ•°
function sendApplyNotify() {
  const orderInput = orderNo.value.trim();
  const urlMatch = orderInput.match(/https?:\/\/[\S]+/);
  if (!urlMatch) {
    showToast('è¯·ç²˜è´´å®Œæ•´çš„å•å·é“¾æ¥', 'warning');
    return;
  }
  const orderUrl = urlMatch[0];
  const orderNum = orderUrl.match(/(\d+)(?!.*\d)/)?.[0] || '';
  if (!orderNum) {
    showToast('é“¾æ¥ä¸­æœªæ‰¾åˆ°å•å·æ•°å­—', 'warning');
    return;
  }
  const brand2 = oldBrand.value.trim();
  const pn2 = oldPN.value.trim();
  const sn2 = oldSN.value.trim();
  if (!brand2 || !sn2 || !pn2) {
    showToast('æ—§ä»¶å“ç‰Œã€æ—§ä»¶SNã€æ—§ä»¶PNå‡ä¸ºå¿…å¡«é¡¹', 'warning');
    return;
  }
  fetch('https://test.jsjs.net', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'apply',
      orderNum,
      orderUrl,
      brand2,
      sn2,
      pn2
    }),
  })
  .then(async res => {
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(errText || 'ç½‘ç»œé”™è¯¯');
    }
    return res.json();
  })
  .then(data => {
    showToast('ç”³é¢†é€šçŸ¥å·²å‘é€ âœ…', 'success');
    console.log(data);
  })
  .catch(err => {
    showToast('ç”³é¢†é€šçŸ¥å‘é€å¤±è´¥ âŒ', 'danger');
    console.error(err);
  });
}

// åˆå§‹åŒ–
updateBrandOptions(typeSelect.value);
update();
</script>


</body>

</html>
